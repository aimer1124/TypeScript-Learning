name: Gmail Fetch

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 * * * *" # hourly; adjust as needed

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install deps
        run: npm install

      - name: Write credentials
        run: |
          mkdir -p .credentials
          printf "%s" "$GOOGLE_CLIENT_SECRET_JSON" > google_client_secret.json
          printf "%s" "$GMAIL_TOKENS_JSON" > .credentials/gmail-token.json
        env:
          GOOGLE_CLIENT_SECRET_JSON: ${{ secrets.GOOGLE_CLIENT_SECRET_JSON }}
          GMAIL_TOKENS_JSON: ${{ secrets.GMAIL_TOKENS_JSON }}

      - name: Fetch and extract verification codes
        run: npm run gmail:fetch
        env:
          GMAIL_QUERY: ${{ secrets.GMAIL_QUERY }}
          CODE_REGEX: ${{ secrets.CODE_REGEX }}
